%{
EEG_Compute_Spectra
Author: Tom Bullock, UCSB Attention Lab
Date: 12.09.20

Compute spectra using FFTs

%}

clear
close all

% set dirs
sourceDir = '/home/bullock/CBF_Attention/EEG_Ep_Task';
destDir = '/home/bullock/CBF_Attention/Data_Compiled';

% subjects
subjects = [134,237,350,576,577,578,588,592,249,997:999];

% loop
for iSub=1:length(subjects)
    sjNum=subjects(iSub);
    for iCond=1:4
        
        if       iCond==1; thisCond='air';
        elseif   iCond==2; thisCond='hypercapnia';
        elseif   iCond==3; thisCond='hypocapnia';
        elseif   iCond==4; thisCond='hypoxia';
        end
        
        for iPhase=1:2
            
            if       iPhase==1; thisPhase='fix';
            elseif   iPhase==2; thisPhase='task';
            end
            
            % load data
            load([sourceDir '/' sprintf('sj%02d_%s_%s45_ft_ep.mat',sjNum,thisCond,thisPhase)])
            
            
            
            % get spectra using fft
            eegData.ALLEEG = EEG;
            tstart=30*250; %samples
            tend=43*250; %samples %%%%WHY CUT OFF AT 44??
            
            L = length(eegData.ALLEEG.data(1,tstart:tend,1)); % Length of signal
            NFFT =(L*3)-3; %L
            
            for i = 1:length(eegData.ALLEEG.epoch)
                
                for channel = 1:eegData.ALLEEG.nbchan; % THIS does an FFT for each channel (may want to reduce number of chans here)
                    %spectra(i,channel,:) = fft(eegData.ALLEEG.data(channel,tstart:tend,i),NFFT)/L;  % spectra matrix = 360 (epochs) X 60 (chans) x 2048 (nearest power of 2 to 1500, which is the number of samples per epoch)
                    spectra(i,channel,:) = fft(eegData.ALLEEG.data(channel,tstart:tend,i),NFFT)/L;
                end
            end
            
            % get freqs
            freqs = 250/2*linspace(0,1,NFFT/2+1);
            
            spectraOrig = [];
            spectraOrig = spectra;
            
            % reduce freqs
            find(freqs==
            
            
            % average over all epochs
            %spectra = squeeze(mean(spectra,1));
            spectra = (abs(spectra)).^2;
            spectra = squeeze(mean(spectra,1));
            %spectra = squeeze(mean((abs(spectra).^2),1));
            
            
            allSpectra(iSub,iCond,iPhase,:,:) = spectra;
            
            clear spectra
            
            
            
        end
    end
end

theseChans = 10:15;

plot(squeeze(mean(mean(allSpectra(:,1,1,theseChans,:),1),4)))



