%{
Spectra_Hilbert_Main
Author: Tom Bullock, UCSB Attention Lab
Date: 05.28.18

Load long epoched data, do hilbert transform, created data plots and
averaged data mats.

%}

clear 
close all

%% dir
sourceDir = '/home/bullock/CBF_Attention/EEG_Ep_Task';
destDir = '/home/bullock/CBF_Attention/Data_Compiled';

%psList = [134 237  576 577 578 592 588 350];
%psList = [134 576 577 578 592 237 350 588]; % matches bloodflow order 
subjects = 249;

% loop through subs
for iSub=1:length(subjects)
    sjNum=subjects(iSub);

    % loop through gas challenge conditions
    for iCond=1:4
        
        if iCond==1
            thisCond = 'air';
        elseif iCond==2
            thisCond = 'hypercapnia';
        elseif iCond==3
            thisCond = 'hypocapnia';
        elseif iCond==4
            thisCond = 'hypoxia';
        end
        
        hilbertEEG = [];

        % load 90 s epoch data
        load([sourceDir '/' sprintf('sj%d_',sjNum) thisCond '_fixTask90_ft_ep.mat'])
        
        % apply Butterworth Filter to isolate 8-12 Hz activity
        filterorder = 3;
        type = 'bandpass';
        [z1,p1] = butter(filterorder, [8,12]./(EEG.srate/2),type);
        data = double(EEG.data);
        tempEEG = NaN(size(data,1),EEG.pnts,size(data,3));
        for x = 1:size(data,1) % loop through chans
            for y = 1:size(data,3) % loop through trials
                dataFilt1 = filtfilt(z1,p1,data(x,:,y)); % was filtfilt
                tempEEG(x,:,y) = dataFilt1; % tymp = chans x times x trials
            end
        end
        
        eegBand = [];
        eegBand = tempEEG;
        
        % apply Hilbert to each channel and trial
        eegs = [];
        for j=1:size(tempEEG,1) % chan loop
            for i=1:size(tempEEG,3) % trial loop
                eegs(i,j,:) = hilbert(squeeze(tempEEG(j,:,i)));
                
                hilbertEEG(j,
                
            end
        end
        
        
        
        % bandpass filter (SHOULD THIS BE 8-12?)
        hilbertFreqs = [8 12]; % was previously set to 9-12
        filtEEG = pop_eegfiltnew(EEG,hilbertFreqs(1),hilbertFreqs(2));
        
        %loop through scalp chans and do hilbert (IS THIS CORRECT
        %ORIENTATION OF MATRIX)??? (19 x 22500 x 8)
        for i=1:19
            i
            hilbertEEG(i,:,:) = hilbert(squeeze(filtEEG.data(i,:,:))')';
        end
        
        %convert complex fourier coefficients to power (NOTE THIS WAS JUST
        %AMP)
        hilbertEEG = [abs(hilbertEEG).^2];
        
        %average over electrodes and epochs
        allHilbert(iSub,iCond,:) = mean(mean(hilbertEEG(10:15,:,:),1),3);
        
    end
end

%plot means for each condition
%meanHilbert = squeeze(mean(allHilbert,1));

%save('A_HILBERT_MEANS.mat','meanHilbert');

% downsample to 1Hz by averaging over 250 samples rather than just taking
% each point
for i=1:90
    j=i*250;
    downsampledHilbert(:,:,i) = mean(allHilbert(:,:,(j-249):j),3);  
end

save([destDir '/' 'A_Hilbert_Means_Alpha_Main.mat'],'downsampledHilbert');

%downsample for plotting (1 sample per second works well)
%meanHilbert = meanHilbert(:,1:250:end);

downsampledHilbert = squeeze(mean(downsampledHilbert,1));

plot(downsampledHilbert(1,:),'g');hold on
plot(downsampledHilbert(2,:),'r')
plot(downsampledHilbert(3,:),'b')
plot(downsampledHilbert(4,:),'m')




        
        